@{
    ViewBag.Title = "Tarifa";
}

<script src="@Url.Content("~/Scripts/Home/TarifaController.js")" type="text/javascript"></script>

<div>
    <h2>Tarifa</h2>

    <input type="button" value="Dodaj novu tarifu" onclick="openNewTarifaDialog();" />

    <table id="TarifaTable"></table>
    <div id="TarifaTablePager"></div>
    <br /><br />

    <div id="TarifaInput" ng-app>
        <div id="divNgController" ng-controller="TarifaController">
            <table>
                <tr>
                    <td>Naziv:</td>
                    <td>
                        <input ng-model="selectedTarifa.Naziv" />
                    </td>
                    <td>
                        <span class="validation" name="RequiredField" ng-show="!validation.isNazivExist()"></span>
                        <span class="validation" ng-show="!validation.isNazivValid()">Naziv ne može imati više od 100 znakova.</span>
                    </td>
                </tr>
                <tr>
                    <td>Tarifa:</td>
                    <td>
                        <input ng-model="selectedTarifa.Stopa" />
                    </td>
                    <td>
                        <span class="validation" ng-show="!validation.isStopaValid()">Neispravna tarifna stopa.</span>
                    </td>
                </tr>
                <tr ng-show="!isSelectedTarifaNew()">
                    <td>Aktivna:</td>
                    <td>
                        <input type="checkbox" ng-model="selectedTarifa.IsActive" />
                    </td>
                    <td></td>
                </tr>
            </table>

		    <input type="button" value="Pohrani" ng-click="save()" />
		    <input type="button" value="Odustani" onclick="closeTarifaDialog()" />
        </div>
    </div>
</div>

<script type="text/javascript">
    var ngControllerScope;

    function getNgControllerScope() {
        if (!ngControllerScope) {
            ngControllerScope = angular.element($("#divNgController")).scope();
        }

        return ngControllerScope;
    }

    var dataAnnotations = DataAnnotations();
    $("span[name=RequiredField]").text(dataAnnotations.Required);

    $("#TarifaInput").dialog({
        modal: true,
        width: "700px"
    });

    function closeTarifaDialog() {
        $("#TarifaInput").dialog("close");
    }

    function openTarifaDialog() {
        $("#TarifaInput").dialog("open");
    }

    function openNewTarifaDialog() {
        var scope = getNgControllerScope();
        scope.newTarifa();
        openTarifaDialog();
    }

    $(document).on("TarifaIsSaved", function () {
        closeTarifaDialog();
        $("#TarifaTable").trigger("reloadGrid");
    });

    closeTarifaDialog();

    $("#TarifaTable").jqGrid({
        url: "/JsonService/GetTarifaCollectionForPaging",
        datatype: "json",
        colNames: ["TarifaId", "Naziv", "Stopa", "IsActive"],
        colModel: [
            { name: "TarifaId", index: "TarifaId", hidden: true, width: 0 },
            { name: "Naziv", index: "Naziv", width: 250 },
            { name: "Stopa", index: "Stopa", width: 200 },
            { name: "IsActive", index: "IsActive", width: 50, formatter: "select", editoptions: { value: "true:Da;false:Ne"} }
        ],
        pager: "#TarifaTablePager",
        caption: "Lista tarifa",
        onSelectRow: function (id) {
            var rowData = $(this).getRowData(id);
            var scope = getNgControllerScope();
            scope.loadTarifa(rowData["TarifaId"]);
            openTarifaDialog();
        }
    }).filterToolbar({ groupOp: "AND", stringResult: true, searchOnEnter: false });

    $("#TarifaTable").jqGrid("navGrid", "#TarifaTablePager");
</script>